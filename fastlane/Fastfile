# fastlane/Fastfile for sagip-ph-app
# Appflow-ready lane: builds Debug & Release APK & AAB

default_platform(:android)

platform :android do

  desc "Appflow-ready full build: npm install, frontend build, Capacitor sync, Gradle builds"
  lane :build_all do

    # --- Step 0: Set JAVA_HOME dynamically ---
    require 'rbconfig'
    if RbConfig::CONFIG['host_os'] =~ /mswin|mingw|cygwin/
      # Windows local path (short path avoids spaces)
      ENV["JAVA_HOME"] ||= "C:\\Progra~1\\Java\\jdk-17"
    else
      # Linux / Appflow CI path
      ENV["JAVA_HOME"] ||= "/usr/lib/jvm/java-17-openjdk-amd64"
    end
    UI.message("â„¹ï¸ JAVA_HOME is set to: #{ENV['JAVA_HOME']}")

    # --- Step 1: Install npm dependencies ---
    UI.message("ğŸ“¦ Installing npm dependencies...")
    sh("npm install")

    # --- Step 2: Build frontend ---
    UI.message("ğŸ—ï¸ Building frontend (web assets)...")
    sh("npm run build")

    # --- Step 3: Sync Capacitor ---
    UI.message("ğŸ”— Syncing Capacitor Android...")
    sh("npx cap sync android")

    # --- Step 4: Gradle builds ---
    gradle_dir = "./android"

    UI.message("âš¡ Building Debug APK & AAB...")
    gradle(task: "assembleDebug", project_dir: gradle_dir)
    gradle(task: "bundleDebug", project_dir: gradle_dir)
    UI.success("âœ… Debug build finished. Outputs in android/app/build/outputs/")

    UI.message("âš¡ Building Release APK & AAB...")
    gradle(task: "assembleRelease", project_dir: gradle_dir)
    gradle(task: "bundleRelease", project_dir: gradle_dir)
    UI.success("âœ… Release build finished. Outputs in android/app/build/outputs/")

    # --- Optional: Print output files ---
    UI.message("ğŸ“ Build outputs can be found in:")
    sh("ls -1 #{gradle_dir}/app/build/outputs/apk/debug")
    sh("ls -1 #{gradle_dir}/app/build/outputs/apk/release")
    sh("ls -1 #{gradle_dir}/app/build/outputs/bundle/debug")
    sh("ls -1 #{gradle_dir}/app/build/outputs/bundle/release")

  end

end
